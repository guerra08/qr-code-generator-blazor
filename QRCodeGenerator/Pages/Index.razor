@page "/"

<div class="title-container">
    <h1 style="text-align: center">QR Code Generator</h1>
    <h3 style="text-align: center">Generate a QR code using whatever text data you want😀</h3>
    <h4 style="text-align: center">Simply add pairs of titles and data and generate the QR code.</h4>
</div>

<div class="form-container">
    <EditForm Model="@_entries" OnValidSubmit="@HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="form-row add-button">
            <button type="button" class="btn btn-secondary" @onclick="@(AddEntry)">Add Data</button>
        </div>
        @for (var i = 0; i < _entries.Count; i++)
        {
            var index = i;

            <div class="form-row">
                <div class="form-group col-md-6">
                    <InputText id="name" class="form-control" placeholder="Name" @bind-Value="_entries[index].Name" required />
                </div>
                <div class="form-group col-md-6">
                    <InputText id="content" class="form-control" type="text" placeholder="Content" @bind-Value="_entries[index].Content" required />
                </div>
                <div class="form-group col-md-6">
                    <button type="button" class="btn btn-warning" @onclick="@(() => RemoveEntry(index))">Remove data</button>
                </div>
            </div>
        }
        @if (_entries.Count > 0)
        {
            <div class="form-buttons">
                <button type="submit" class="btn btn-primary">Create</button>
                <button type="reset" class="btn btn-danger">Cancel</button>
            </div>
        }
    </EditForm>
</div>

@if (_image is not null && _entries.Count > 0)
{
    <div class="card-qr-container">
        <div class="card" style="width: 18rem;">
            <div class="card-body">
                @foreach (var entry in _entries)
                {
                    <p class="card-text"><strong>@entry.Name:</strong> @entry.Content</p>
                }
            </div>
        </div>
        <div class="qr-container">
            <img src="data:image/png;base64,@Convert.ToBase64String(_image)" alt="QR Code">
        </div>
    </div>
}

@code{

    private readonly List<Models.FormModel> _entries = new();
    private byte[]? _image;

    private void HandleValidSubmit()
    {
        var qrGenerator = new QRCoder.QRCodeGenerator();
        var qrData = qrGenerator.CreateQrCode(
            BuildQrString(),
            QRCoder.QRCodeGenerator.ECCLevel.Q);
        var qrCode = new QRCoder.PngByteQRCode(qrData);
        _image = qrCode.GetGraphic(20);
    }

    private void RemoveEntry(int index)
    {
        _entries.RemoveAt(index);
        _image = null;
    }

    private void AddEntry()
    {
        if (_image is not null) _image = null;
        _entries.Add(new Models.FormModel());
    }

    private string BuildQrString()
    {
        return string.Join("", _entries);
    }

}